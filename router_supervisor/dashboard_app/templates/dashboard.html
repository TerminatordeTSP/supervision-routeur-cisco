{% extends 'base.html' %}
{% block content %}
<style>
body {
    background: #261910;
    color: #fff;
    font-family: 'Segoe UI', Arial, sans-serif;
}
.dashboard-container {
    max-width: 1100px;
    margin: 40px auto 0;
    padding: 20px;
}
.dashboard-title {
    color: orange;
    margin-bottom: 24px;
}
.top-cards, .mid-cards, .charts-row {
    display: flex;
    gap: 24px;
    margin-bottom: 24px;
}
.card, .chart-card {
    background: #2e1b0f;
    border-radius: 16px;
    box-shadow: 0 2px 10px #0002;
    padding: 20px;
    flex: 1 1 0px;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.big-number {
    font-size: 2.4em;
    color: orange;
    margin-top: 4px;
}
.unit {
    color: #ffa50099;
    font-size: 1.1em;
}
.bar-bg {
    width: 100%;
    height: 8px;
    background: #633910;
    border-radius: 6px;
    margin: 12px 0 0 0;
    overflow: hidden;
}
.bar {
    height: 100%;
    background: orange;
    width: 0%;
    transition: width 0.4s cubic-bezier(.6,.2,.5,1);
}
.router-info {
    margin-top: 36px;
    background: #2e1b0f;
    border-radius: 16px;
    padding: 18px 28px;
}
.router-info-title {
    color: orange;
    font-size: 1.2em;
    margin-bottom: 6px;
    display: inline-block;
}
.router-details {
    margin-top: 8px;
    color: #fff;
}
</style>

<div class="dashboard-container">
    <h2 class="dashboard-title">Welcome to the Dashboard</h2>
    <div class="top-cards">
        <div class="card">
            <span>ROUTER CPU</span>
            <span class="big-number" id="router_cpu">0</span> <span class="unit">%</span>
        </div>
        <div class="card">
            <span>ROUTER UPTIME</span>
            <span class="big-number" id="router_uptime">0</span> <span class="unit">h</span>
        </div>
        <div class="card">
            <span>SYSTEM CPU</span>
            <span class="big-number" id="system_cpu">0</span> <span class="unit">%</span>
        </div>
    </div>
    <div class="mid-cards">
        <div class="card">
            <span>LATENCY</span>
            <span class="big-number" id="latency">0</span> <span class="unit">ms</span>
        </div>
        <div class="card">
            <span>SYSTEM LOAD</span>
            <span class="big-number" id="system_load">0</span>
        </div>
        <div class="card">
            <span>RAM USAGE</span>
            <span class="big-number" id="ram_usage">0</span> <span class="unit">%</span>
        </div>
    </div>
    <div class="charts-row">
        <div class="chart-card">
            <span>Router CPU Usage</span>
            <span id="router_cpu_bar">0%</span>
            <div class="bar-bg">
                <div class="bar" id="router_cpu_progress" style="width: 0%;"></div>
            </div>
        </div>
        <div class="chart-card">
            <span>Memory Usage</span>
            <span id="memory_usage_bar">0%</span>
            <div class="bar-bg">
                <div class="bar" id="memory_usage_progress" style="width: 0%;"></div>
            </div>
        </div>
        <div class="chart-card">
            <span>Network Latency</span>
            <span id="latency_bar">0 ms</span>
            <div class="bar-bg">
                <div class="bar" id="latency_progress" style="width: 0%;"></div>
            </div>
        </div>
    </div>
    <div class="router-info">
        <span class="router-info-title">Router Information</span>
        <div class="router-details">
            <span>
                <b>Router Name:</b> <span id="router_name"></span>
                <b>Last Updated:</b> <span id="last_updated"></span>
            </span>
        </div>
    </div>
</div>

<script>
function fetchMetrics() {
    fetch('/api/latest_metrics/')
        .then(response => response.json())
        .then(data => {
            let cpu = data.find(x => x.field === "cpu_0_usage");
            let ram = data.find(x => x.field === "used_percent" || x.field === "ram_used");
            let latency = data.find(x => x.field === "latency_ms");
            let uptime = data.find(x => x.field === "uptime");
            let sys_cpu = data.find(x => x.field === "usage_system");
            let sys_load = data.find(x => x.field === "load1");

            document.getElementById('router_cpu').textContent = cpu ? cpu.value : "0";
            document.getElementById('system_cpu').textContent = sys_cpu ? sys_cpu.value : "0";
            document.getElementById('system_load').textContent = sys_load ? sys_load.value : "0";
            document.getElementById('latency').textContent = latency ? latency.value : "0";
            document.getElementById('ram_usage').textContent = ram ? ram.value : "0";
            document.getElementById('router_uptime').textContent = uptime ? (uptime.value / 3600).toFixed(2) : "0";

            document.getElementById('router_cpu_bar').textContent = cpu ? cpu.value + "%" : "0%";
            document.getElementById('memory_usage_bar').textContent = ram ? ram.value + "%" : "0%";
            document.getElementById('latency_bar').textContent = latency ? latency.value + " ms" : "0 ms";
            document.getElementById('router_cpu_progress').style.width = cpu ? (cpu.value || 0) + "%" : "0%";
            document.getElementById('memory_usage_progress').style.width = ram ? (ram.value || 0) + "%" : "0%";
            document.getElementById('latency_progress').style.width = latency ? Math.min((latency.value || 0) / 10, 100) + "%" : "0%";

            if (cpu && cpu.tags && cpu.tags.hostname) {
                document.getElementById('router_name').textContent = cpu.tags.hostname;
            } else {
                document.getElementById('router_name').textContent = '';
            }

            if (cpu && cpu.time) {
                document.getElementById('last_updated').textContent = cpu.time.replace("T", " ").replace("Z", "");
            } else {
                document.getElementById('last_updated').textContent = '';
            }
        });
}
setInterval(fetchMetrics, 5000);
fetchMetrics();
</script>
{% endblock %}