#!/bin/sh
set -e

# Se d√©placer dans le r√©pertoire du projet Django
cd /code

# Activer l'environnement virtuel s'il existe
if [ -d "/code/venv" ]; then
    echo "Activating virtual environment..."
    . /code/venv/bin/activate
fi

echo "üîÑ Checking and applying database migrations..."

# Cr√©er les migrations si n√©cessaire
echo "Creating migrations for all apps..."
python router_supervisor/manage.py makemigrations --noinput || echo "‚ö†Ô∏è makemigrations failed, continuing..."

# Appliquer les migrations
echo "Applying database migrations..."
python router_supervisor/manage.py migrate --noinput || echo "‚ö†Ô∏è migrate failed, continuing..."

# Collecter les fichiers statiques
echo "Collecting static files..."
python router_supervisor/manage.py collectstatic --noinput --clear || echo "‚ö†Ô∏è collectstatic failed, continuing..."

# Cr√©er le superuser s'il n'existe pas
echo "Ensuring superuser exists..."
python router_supervisor/manage.py shell < router_supervisor/create_superuser.py 2>/dev/null || echo "‚ö†Ô∏è superuser creation failed, continuing..."

echo "‚úÖ Database and static files ready!"

# D√©marrer Gunicorn avec fichier de configuration
echo "üöÄ Starting Gunicorn server..."
exec gunicorn router_supervisor.src.wsgi:application \
    --config /code/gunicorn.conf.py